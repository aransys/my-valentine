<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#ffedf5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Will you be my Valentine?</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg: linear-gradient(135deg, #ffd6e8, #e0ccff, #cce6ff);
      --text: #1f2937;
      --soft: #6b7280;
      --pink: #ff4d8d;
    }

    body {
      min-height: 100vh;
      min-height: 100dvh;
      font-family: "Inter", system-ui, sans-serif;
      font-size: clamp(16px, 2.2vw, 20px);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      padding-left: max(1.5rem, env(safe-area-inset-left));
      padding-right: max(1.5rem, env(safe-area-inset-right));
      padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
      padding-top: max(1.5rem, env(safe-area-inset-top));
      overflow-x: hidden;
      overflow-y: auto;
      transition: background 0.25s ease;
    }

    body.tapped {
      background: linear-gradient(135deg, #ffe5f0, #e8dcff, #dceeff);
    }

    .app {
      width: min(540px, 100%);
      text-align: center;
    }

    .hint {
      font-size: clamp(0.95rem, 2.2vw, 1.1rem);
      color: var(--soft);
      margin-bottom: 2rem;
      opacity: 0;
      animation: fadeIn 0.6s ease forwards;
    }

    .heart-wrap {
      position: relative;
      margin-bottom: 2.5rem;
      touch-action: manipulation;
      min-height: clamp(160px, 35vw, 240px);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .heart {
      font-size: clamp(4.5rem, 12vw, 6rem);
      cursor: pointer;
      user-select: none;
      display: inline-block;
      transform-origin: center;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      margin-top: 10px;
      /* Improve text rendering for emoji */
      -webkit-font-smoothing: antialiased;
    }

    /* New CSS Animation for the squish effect */
    .heart.beating {
      animation: heartBeat 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transition: none; /* Disable transition during animation to prevent conflict */
    }

    @keyframes heartBeat {
      0% { transform: scale(1); }
      40% { transform: scale(0.85); }
      100% { transform: scale(1); }
    }

    .heart:focus-visible {
      outline: 2px solid var(--pink);
      outline-offset: 4px;
      border-radius: 8px;
    }

    .heart.pop {
      animation: heartPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      pointer-events: none;
    }

    @keyframes heartPop {
      0% { transform: scale(var(--pop-scale, 1)); opacity: 1; }
      40% { transform: scale(calc(var(--pop-scale, 1) * 1.4)); opacity: 1; }
      100% { transform: scale(calc(var(--pop-scale, 1) * 2.2)); opacity: 0; }
    }

    .burst-particle {
      position: fixed;
      font-size: clamp(1.2rem, 3vw, 1.6rem);
      pointer-events: none;
      z-index: 10;
      animation: burstOut 0.6s ease-out forwards;
    }

    @keyframes burstOut {
      0% {
        transform: translate(0, 0) scale(0.5);
        opacity: 1;
      }
      100% {
        transform: translate(var(--bx), var(--by)) scale(1);
        opacity: 0;
      }
    }

    .love-bar {
      width: min(420px, 85%);
      height: clamp(14px, 3.6vw, 18px);
      background: rgba(255, 255, 255, 0.7);
      border-radius: 999px;
      margin: 0 auto 2rem;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(31, 41, 55, 0.08);
    }

    .love-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff4d8d, #ff7ab6);
      border-radius: inherit;
      transition: width 0.35s ease;
    }

    .message {
      min-height: 2.5rem;
      font-size: clamp(1.15rem, 2.6vw, 1.35rem);
      font-weight: 600;
      margin: 3.5rem 0 1.75rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .message.show {
      opacity: 1;
    }

    .buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .buttons.show {
      opacity: 1;
      pointer-events: auto;
    }

    .buttons.single-yes #yes {
      display: none;
    }

    .buttons.single-yes #maybe {
      width: 100%;
      padding: 1.25rem 1.5rem;
      font-size: clamp(1.2rem, 2.8vw, 1.4rem);
    }

    button {
      border: none;
      padding: 1.1rem 1.4rem;
      min-height: 52px;
      border-radius: 16px;
      font-size: clamp(1.05rem, 2.4vw, 1.2rem);
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(31, 41, 55, 0.12);
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease, background 0.2s ease;
      touch-action: manipulation;
    }

    button:active {
      transform: scale(0.97) translateY(2px);
      box-shadow: 0 1px 4px rgba(31, 41, 55, 0.15);
    }

    button:focus-visible {
      outline: 2px solid var(--pink);
      outline-offset: 3px;
    }

    .yes {
      background: var(--pink);
      color: white;
    }

    .maybe {
      background: rgba(255, 255, 255, 0.85);
      color: var(--text);
    }

    .btn-shake {
      animation: btnShake 0.4s ease-in-out;
    }

    @keyframes btnShake {
      0%, 100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(5px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(3px); }
    }

    .success {
      position: fixed;
      inset: 0;
      background: #ffedf5;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      z-index: 100;
    }

    .success.show {
      opacity: 1;
      pointer-events: auto;
    }

    .success-inner {
      cursor: pointer;
      padding: 1rem;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
    }

    .success-title {
      font-size: clamp(2.75rem, 7vw, 3.6rem);
      margin-bottom: 0.5rem;
      animation: success-pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .success-sub {
      font-size: clamp(1.15rem, 2.6vw, 1.35rem);
      color: var(--soft);
    }

    .success-hearts {
      font-size: clamp(2.4rem, 6vw, 3rem);
      margin-top: 1rem;
      animation: wiggle 0.5s ease-in-out infinite;
    }

    .success-tap-hint {
      font-size: clamp(0.95rem, 2.2vw, 1.1rem);
      color: var(--soft);
      margin-top: 0.75rem;
      opacity: 0.8;
    }

    @keyframes success-pop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes wiggle {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }

    .replay-btn {
      margin-top: 1.5rem;
    }

    .particle {
      position: fixed;
      font-size: clamp(1.6rem, 4vw, 2.1rem);
      pointer-events: none;
      animation: floatUp 2.5s ease forwards;
      z-index: 5;
    }

    @keyframes floatUp {
      from {
        transform: translateY(0) scale(0.6);
        opacity: 1;
      }
      to {
        transform: translateY(-120vh) scale(1.1);
        opacity: 0;
      }
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <p class="hint">tap the heart</p>

    <div class="heart-wrap">
      <div class="heart" id="heart" tabindex="0" role="button" aria-label="Tap the heart">‚ù§Ô∏è</div>
    </div>

    <div class="love-bar" aria-hidden="true">
      <div class="love-bar-fill" id="loveBarFill"></div>
    </div>

    <div class="message" id="message" aria-live="polite" aria-atomic="true"></div>

    <div class="buttons" id="buttons">
      <button class="yes" id="yes">yes duh üíó</button>
      <button class="maybe" id="maybe">i'm scared üò≠</button>
    </div>
  </div>

  <div class="success" id="success" role="dialog" aria-modal="true" aria-labelledby="successTitle" aria-describedby="successSub" aria-hidden="true">
    <div class="success-inner" id="successInner" tabindex="-1">
      <h1 class="success-title" id="successTitle">ok wow</h1>
      <p class="success-sub" id="successSub">that was a yes</p>
      <div class="success-hearts" aria-hidden="true">üíû üò≠ ü´∂ üíó ‚ú®</div>
      <p class="success-tap-hint" id="successTapHint">tap for more confetti ‚ú®</p>
      <button class="yes replay-btn" id="replay" type="button">play again</button>
    </div>
  </div>

  <script>
    const app = document.querySelector(".app");
    const heart = document.getElementById("heart");
    const message = document.getElementById("message");
    const loveBarFill = document.getElementById("loveBarFill");
    const buttons = document.getElementById("buttons");
    const yesBtn = document.getElementById("yes");
    const maybeBtn = document.getElementById("maybe");
    const success = document.getElementById("success");
    const successInner = document.getElementById("successInner");
    const successTitle = document.getElementById("successTitle");
    const successSub = document.getElementById("successSub");
    const replayBtn = document.getElementById("replay");

    // --- Audio System (Web Audio API) ---
    // This creates simple synthesized sounds without needing external files
    let audioCtx = null;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    }

    function playTone(freq, type = 'sine', duration = 0.1, delay = 0, volume = 0.03) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
      gain.gain.setValueAtTime(volume, audioCtx.currentTime + delay);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start(audioCtx.currentTime + delay);
      osc.stop(audioCtx.currentTime + delay + duration);
    }

    function playTapSound() {
      if (!audioCtx) return;
      const freq = 520 + Math.random() * 120;
      playTone(freq, 'sine', 0.06, 0, 0.025);
      playTone(freq * 1.25, 'sine', 0.08, 0.02, 0.015);
    }

    function playSuccessSound() {
      if (!audioCtx) return;
      playTone(523.25, 'sine', 0.25, 0, 0.035);
      playTone(659.25, 'sine', 0.25, 0.06, 0.03);
      playTone(783.99, 'sine', 0.3, 0.12, 0.03);
      playTone(1046.50, 'sine', 0.5, 0.18, 0.025);
    }

    function playPopSound() {
      if (!audioCtx) return;
      playTone(300, 'sine', 0.08, 0, 0.03);
      playTone(220, 'sine', 0.12, 0.04, 0.025);
    }

    function vibrate(pattern) {
      if (!navigator.vibrate) return;
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      navigator.vibrate(pattern);
    }

    // --- Text Content ---
    const messages = [
      "hey",
      "okay wait",
      "why is this cute",
      "don‚Äôt stop",
      "omg",
      "okay that was kinda cute",
      "stoppp",
      "why is this working",
      "no seriously",
      "don't stop now",
      "keep going",
      "i'm weak",
      "omg omg",
      "WAIT",
      "okay yeah",
      "fine you win"
    ];

    const maybeTexts = [
      "idk‚Ä¶",
      "don't look at me",
      "wait"
    ];

    const MAYBE_GIVE_IN = maybeTexts.length;

    const successHeadlines = [
      "ok wow",
      "let's gooo",
      "yes!!!",
      "we're doing this üíó",
      "omg okay",
      "i'm so happy"
    ];

    const successSublines = [
      "that was a yes",
      "u said yes",
      "valentine mode: on",
      "best answer ever"
    ];

    const successMaybeSublines = [
      "that was a yes (eventually üíó)",
      "okay fine that's a yes",
      "knew u'd come around"
    ];

    const successPopHeadlines = [
      "you popped it üò≠",
      "RIP heart üíî",
      "okay that was intense",
      "heart.exe has stopped",
      "you really went for it",
      "ded üíÄ"
    ];

    const successPopSublines = [
      "that counts as a yes",
      "aggressive yes but still yes",
      "the heart couldn't take it",
      "valentine achieved through violence",
      "still a yes though üíó"
    ];

    let taps = 0;
    let maybeClicks = 0;
    let extraTaps = 0;
    let rapidTapTimeout = null;
    let isPopping = false;
    const RAPID_TAP_MS = 500;
    const POP_AFTER_TAPS = 5;

    function updateLoveBar() {
      const progress = Math.min(taps, messages.length);
      const percent = Math.round((progress / messages.length) * 100);
      loveBarFill.style.width = `${percent}%`;
    }

    // UPDATED: CSS Animation Approach
    function squish() {
      // Reset animation
      heart.classList.remove("beating");
      // Force reflow
      void heart.offsetWidth;
      // Trigger animation
      heart.classList.add("beating");
    }

    function particle() {
      const p = document.createElement("div");
      p.className = "particle";
      p.textContent = ["üíó","üíû","ü´∂","üò≠"][Math.floor(Math.random()*4)];
      const padding = 25;
      const range = Math.max(0, window.innerWidth - padding * 2);
      p.style.left = (padding + Math.random() * range) + "px";
      p.style.bottom = "-20px";
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 2500);
    }

    function burstParticle(cx, cy) {
      const p = document.createElement("div");
      p.className = "burst-particle";
      p.textContent = ["üíó","üíû","ü´∂","‚ù§Ô∏è","üíï","‚ú®"][Math.floor(Math.random()*6)];
      const angle = Math.random() * Math.PI * 2;
      const dist = 80 + Math.random() * 120;
      const tx = Math.cos(angle) * dist;
      const ty = Math.sin(angle) * dist - 40;
      p.style.left = cx + "px";
      p.style.top = cy + "px";
      p.style.setProperty("--bx", tx + "px");
      p.style.setProperty("--by", ty + "px");
      document.body.appendChild(p);
      setTimeout(() => p.remove(), 600);
    }

    function triggerPop() {
      if (isPopping) return;
      isPopping = true;
      playPopSound();
      vibrate([40, 25, 40]);

      const rect = heart.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;
      let currentScale = 1;
      const matrix = getComputedStyle(heart).transform;
      if (matrix && matrix !== "none") {
        const m = matrix.match(/matrix\(([^)]+)\)/);
        if (m) currentScale = parseFloat(m[1].split(",")[0]) || 1;
      }
      heart.style.setProperty("--pop-scale", String(currentScale));
      heart.classList.add("pop");

      for (let i = 0; i < 16; i++) {
        setTimeout(() => burstParticle(cx, cy), i * 30);
      }

      setTimeout(() => {
        heart.classList.remove("pop");
        heart.style.removeProperty("--pop-scale");
        heart.style.transform = "scale(1)";
        showSuccess(false, true);
      }, 1200);
    }

    function handleHeartTap() {
      initAudio(); // Initialize audio context on first tap
      if (isPopping) return;

      document.body.classList.add("tapped");
      setTimeout(() => document.body.classList.remove("tapped"), 250);
      
      squish();
      playTapSound();
      vibrate(25);
      particle();

      if (taps >= messages.length) {
        clearTimeout(rapidTapTimeout);
        extraTaps++;
        if (extraTaps >= POP_AFTER_TAPS) {
          triggerPop();
          return;
        }
        rapidTapTimeout = setTimeout(() => { extraTaps = 0; }, RAPID_TAP_MS);
        return;
      }

      message.textContent = messages[taps];
      message.classList.add("show");

      taps++;
      updateLoveBar();

      if (taps === messages.length) {
        setTimeout(() => buttons.classList.add("show"), 400);
      }
    }

    heart.addEventListener("click", handleHeartTap);
    heart.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        handleHeartTap();
      }
    });

    const FOCUSABLES = [successInner, replayBtn];

    function trapFocus(e) {
      if (e.key !== "Tab" || !success.classList.contains("show")) return;
      const idx = FOCUSABLES.indexOf(document.activeElement);
      if (idx === -1) return;
      const next = e.shiftKey ? FOCUSABLES[(idx - 1 + FOCUSABLES.length) % FOCUSABLES.length] : FOCUSABLES[(idx + 1) % FOCUSABLES.length];
      e.preventDefault();
      next.focus();
    }

    function triggerConfetti() {
      if (typeof confetti !== 'function') return;
      const duration = 3000;
      const animationEnd = Date.now() + duration;
      const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 200 };
      const randomInRange = (min, max) => Math.random() * (max - min) + min;

      const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        const particleCount = 50 * (timeLeft / duration);
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
        confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
      }, 250);
    }

    function tapConfettiBurst(x = 0.5, y = 0.5) {
      if (typeof confetti !== 'function') return;
      confetti({ particleCount: 30, spread: 70, origin: { x, y }, startVelocity: 25, zIndex: 200 });
      confetti({ particleCount: 20, spread: 50, origin: { x, y }, startVelocity: 20, scalar: 0.8, zIndex: 200 });
    }

    function showSuccess(fromMaybe = false, fromPop = false) {
      playSuccessSound();
      vibrate([30, 20, 30]);
      triggerConfetti();

      if (fromPop) {
        successTitle.textContent = successPopHeadlines[Math.floor(Math.random() * successPopHeadlines.length)];
        successSub.textContent = successPopSublines[Math.floor(Math.random() * successPopSublines.length)];
      } else {
        successTitle.textContent = successHeadlines[Math.floor(Math.random() * successHeadlines.length)];
        successSub.textContent = fromMaybe
          ? successMaybeSublines[Math.floor(Math.random() * successMaybeSublines.length)]
          : successSublines[Math.floor(Math.random() * successSublines.length)];
      }
      success.classList.add("show");
      success.removeAttribute("aria-hidden");
      if (app) app.setAttribute("aria-hidden", "true");
      document.addEventListener("keydown", trapFocus);
      requestAnimationFrame(() => successInner.focus());
      for (let i = 0; i < 25; i++) {
        setTimeout(particle, i * 80);
      }
    }

    yesBtn.addEventListener("click", () => {
      initAudio();
      showSuccess(false);
    });

    successInner.addEventListener("click", (e) => {
      if (e.target.closest("#replay")) return;
      vibrate(15);
      const x = e.clientX / window.innerWidth;
      const y = e.clientY / window.innerHeight;
      tapConfettiBurst(x, y);
    });

    function yesAfterMaybe() {
      initAudio();
      showSuccess(true);
    }

    function handleMaybeClick() {
      initAudio();
      playTapSound();
      vibrate(25);
      maybeClicks++;
      if (maybeClicks <= MAYBE_GIVE_IN) {
        maybeBtn.textContent = maybeTexts[maybeClicks - 1];
        maybeBtn.classList.remove("btn-shake");
        void maybeBtn.offsetWidth;
        maybeBtn.classList.add("btn-shake");
        setTimeout(() => maybeBtn.classList.remove("btn-shake"), 400);
        return;
      }
      // Conversion to YES
      maybeBtn.textContent = "yes duh üíó";
      maybeBtn.classList.add("yes");
      maybeBtn.classList.remove("maybe");
      maybeBtn.style.transform = "";
      maybeBtn.removeEventListener("click", handleMaybeClick);
      maybeBtn.addEventListener("click", yesAfterMaybe);
      buttons.classList.add("single-yes");
    }

    maybeBtn.addEventListener("click", handleMaybeClick);

    // FIXED: Replay Logic
    function resetMaybeButton() {
      maybeBtn.textContent = "i'm scared üò≠";
      maybeBtn.classList.remove("yes", "btn-shake");
      maybeBtn.classList.add("maybe");
      maybeBtn.style.transform = "";
      
      // CRITICAL FIX: Remove BOTH listeners to ensure clean state
      maybeBtn.removeEventListener("click", yesAfterMaybe);
      maybeBtn.removeEventListener("click", handleMaybeClick);
      
      // Add back the original listener
      maybeBtn.addEventListener("click", handleMaybeClick);
    }

    replayBtn.addEventListener("click", () => {
      success.classList.remove("show");
      success.setAttribute("aria-hidden", "true");
      document.removeEventListener("keydown", trapFocus);
      if (app) app.removeAttribute("aria-hidden");
      buttons.classList.remove("show");
      message.classList.remove("show");
      message.textContent = "";
      taps = 0;
      maybeClicks = 0; // Reset counter
      extraTaps = 0;
      isPopping = false;
      clearTimeout(rapidTapTimeout);
      updateLoveBar();
      heart.classList.remove("pop", "beating");
      heart.style.removeProperty("--pop-scale");
      heart.style.transform = "scale(1)";
      resetMaybeButton();
      buttons.classList.remove("single-yes");
      heart.focus();
    });
  </script>
</body>
</html>